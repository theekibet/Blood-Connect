{% extends 'nurse/nursebase.html' %}
{% load static %}
{% load widget_tweaks %}

{% block content %}
<style>
  .edit-profile-container { max-width: 700px; margin: 2rem auto; }
  .edit-profile-card {
    background-color: #fff;
    border-radius: 12px;
    padding: 2rem 2.5rem;
    box-shadow: 0 8px 16px rgba(0,0,0,0.15);
  }
  .edit-profile-header { font-weight: 700; font-size: 1.8rem; color: #343a40; margin-bottom: 1.5rem; text-align: center; }
  form .form-group { margin-bottom: 1.2rem; }
  label { font-weight: 600; color: #495057; }
  input[type="text"], input[type="email"], input[type="file"], textarea, select {
    border-radius: 6px; border: 1px solid #ced4da; padding: 0.5rem 0.75rem; font-size: 1rem; width: 100%;
    transition: border-color 0.2s ease-in-out;
  }
  input:focus, textarea:focus, select:focus {
    outline: none; border-color: #ff0018; box-shadow: 0 0 0 0.2rem rgba(255,0,24,0.25);
  }
  textarea { min-height: 80px; resize: vertical; }
  .btn-save { background-color: #ff0018; border-color: #ff0018; font-weight: 600; width: 100%; transition: 0.3s; }
  .btn-save:hover { background-color: #cc0013; border-color: #cc0013; }
  .btn-cancel { background-color: #6c757d; border-color: #6c757d; color: #fff; width: 100%; margin-top: 0.75rem; text-align: center; display: block; }
  .btn-cancel:hover { background-color: #5a6268; border-color: #545b62; color: #fff; text-decoration: none; }

  .custom-file-upload {
    display: inline-block; cursor: pointer; background-color: #ff0018; color: white; padding: 10px 20px;
    border-radius: 8px; font-weight: 600; transition: 0.3s; margin-bottom: 1rem;
  }
  .custom-file-upload:hover { background-color: #cc0013; }
  input[type="file"] { display: none; }
  #profilePicPreview {
    display: block; max-width: 180px; max-height: 180px; border-radius: 50%; margin-bottom: 1rem;
    object-fit: cover; border: 3px solid #ff0018; box-shadow: 0 0 8px rgba(255,0,24,0.4);
  }
  .form-check { margin-top: 0.75rem; }
</style>

<div class="edit-profile-container">
  <div class="edit-profile-card">
    <h2 class="edit-profile-header">Edit Profile: {{ nurse.user.get_full_name }}</h2>

    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
      {% endfor %}
    {% endif %}

    <form method="POST" enctype="multipart/form-data" novalidate>
      {% csrf_token %}

      <!-- Account Info (User form) -->
      <h5>Account Information</h5>
      {% for field in user_form %}
        <div class="form-group">
          {{ field.label_tag }}
          {{ field|add_class:"form-control" }}
          {% if field.help_text %}
            <small class="form-text text-muted">{{ field.help_text }}</small>
          {% endif %}
          {% for error in field.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>
      {% endfor %}

      <!-- Profile Info (Nurse form except profile_pic) -->
      <h5 class="mt-4">Profile Information</h5>
      {% for field in nurse_form %}
        {% if field.name != "profile_pic" %}
          <div class="form-group">
            {{ field.label_tag }}
            {{ field|add_class:"form-control" }}
            {% if field.help_text %}
              <small class="form-text text-muted">{{ field.help_text }}</small>
            {% endif %}
            {% for error in field.errors %}
              <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>
        {% endif %}
      {% endfor %}

      <!-- Profile Picture -->
      <div class="form-group">
        <label for="id_profile_pic">Profile Picture</label><br>

        {% if nurse.profile_pic %}
          <img src="{{ nurse.profile_pic.url }}" id="profilePicPreview" alt="Profile Picture Preview" />
        {% else %}
          <img src="{% static 'images/default-profile.png' %}" id="profilePicPreview" alt="No Profile Picture" />
        {% endif %}

        <label for="id_profile_pic" class="custom-file-upload">
          <i class="fas fa-upload"></i> Choose Image
        </label>
        {{ nurse_form.profile_pic }}

        {% if nurse.profile_pic %}
          <div class="form-check">
            <input type="checkbox" class="form-check-input" id="clear_profile_pic" name="clear_profile_pic">
            <label class="form-check-label" for="clear_profile_pic">Remove current picture</label>
          </div>
        {% endif %}

        {% for error in nurse_form.profile_pic.errors %}
          <div class="text-danger small">{{ error }}</div>
        {% endfor %}
      </div>

      <button type="submit" class="btn btn-save">Save Changes</button>
      <a href="{% url 'nurse-profile' nurse.pk %}" class="btn btn-cancel">Cancel</a>
    </form>
  </div>
</div>

<script>
  const fileInput = document.getElementById('id_profile_pic');
  const previewImg = document.getElementById('profilePicPreview');

  if(fileInput) {
    fileInput.addEventListener('change', function(){
      const file = this.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e){
          previewImg.setAttribute('src', e.target.result);
        }
        reader.readAsDataURL(file);
      }
    });
  }
</script>
{% endblock %}
