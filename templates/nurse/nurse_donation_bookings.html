{% extends 'nurse/nursebase.html' %}

{% block content %}
<head>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer" />
        <style>
          :root{--primary-color:#dc3545;--primary-gradient:linear-gradient(135deg,#dc3545 0%,#e17055 100%);--nurse-color:#17a2b8;--nurse-gradient:linear-gradient(135deg,#17a2b8 0%,#20c997 100%);--success-color:#28a745;--warning-color:#ffc107;--info-color:#17a2b8;--danger-color:#dc3545;--secondary-color:#6c757d;--light-bg:#f8f9fa;--border-radius:12px;--shadow:0 6px 18px rgba(23,162,184,0.15);--transition:all .3s ease;}
          .container{max-width:1200px;margin:auto;padding:20px;}
          .page-header{background:var(--nurse-gradient);color:#fff;padding:20px;border-radius:var(--border-radius);margin-bottom:30px;box-shadow:var(--shadow);}
          .page-header h1{margin:0;font-weight:700;display:flex;align-items:center;gap:15px;}
          .message-container{margin-bottom:20px;}
          .search-section{background:#fff;padding:20px;border-radius:var(--border-radius);box-shadow:var(--shadow);margin-bottom:30px;}
          .search-input{border:2px solid #e9ecef;border-radius:8px;padding:12px 20px;font-size:16px;transition:var(--transition);}
          .search-input:focus{border-color:var(--nurse-color);box-shadow:0 0 0 .2rem rgba(23,162,184,.25);}
          .table-container{background:#fff;border-radius:var(--border-radius);box-shadow:var(--shadow);overflow:hidden;}
          table{width:100%;border-collapse:collapse;margin:0;}
          th,td{padding:15px 12px;text-align:left;vertical-align:middle;border-bottom:1px solid #eee;}
          thead th{background:var(--nurse-gradient);color:#fff;font-weight:700;position:sticky;top:0;z-index:10;}
          tbody tr{transition:var(--transition);}
          tbody tr:hover{background-color:#f0fdff;transform:scale(1.01);}
          .status-badge{padding:6px 12px;border-radius:20px;font-size:.85rem;font-weight:600;text-transform:uppercase;letter-spacing:.5px;}
          .status-pending{background:#fff3cd;color:#856404;}
          .status-approved{background:#d4edda;color:#155724;}
          .status-rejected{background:#f8d7da;color:#721c24;}
          .status-completed{background:#d1ecf1;color:#0c5460;}
          .status-cancelled{background:#e2e3e5;color:#383d41;}
          .btn{padding:8px 16px;border:none;border-radius:6px;font-size:.85rem;font-weight:600;cursor:pointer;transition:var(--transition);text-decoration:none;display:inline-flex;align-items:center;gap:6px;margin:2px;}
          .btn:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.15);}
          .btn-success{background:var(--success-color);color:#fff;}
          .btn-danger{background:var(--danger-color);color:#fff;}
          .btn-info{background:var(--info-color);color:#fff;}
          .btn-secondary{background:var(--secondary-color);color:#fff;}
          .btn:disabled{opacity:.6;cursor:not-allowed;transform:none!important;}
          .action-buttons{display:flex;flex-wrap:wrap;gap:5px;}
          .profile-img{width:50px;height:50px;border-radius:50%;border:2px solid var(--nurse-color);object-fit:cover;}
          .donor-info{display:flex;flex-direction:column;}
          .donor-name{font-weight:700;color:#2c3e50;}
          .donor-details{font-size:.85rem;color:#6c757d;}
          .modal-content{border-radius:var(--border-radius);border:none;box-shadow:0 10px 30px rgba(0,0,0,.3);}
          .modal-header{background:var(--nurse-gradient);color:#fff;border-radius:var(--border-radius) var(--border-radius) 0 0;}
          .form-control,.form-select{border:2px solid #e9ecef;border-radius:8px;padding:10px 15px;transition:var(--transition);}
          .form-control:focus,.form-select:focus{border-color:var(--nurse-color);box-shadow:0 0 0 .2rem rgba(23,162,184,.25);}
          .alert{border:none;border-radius:var(--border-radius);padding:15px 20px;margin-bottom:20px;display:flex;align-items:center;gap:10px;}
          .alert-dismissible .btn-close{padding:8px;}
          .no-data{text-align:center;padding:60px 20px;color:#6c757d;}
          .no-data i{font-size:4rem;margin-bottom:20px;opacity:.5;}
          .loading-spinner{display:inline-block;width:1rem;height:1rem;border:.2rem solid transparent;border-top-color:currentColor;border-radius:50%;animation:spin 1s linear infinite;}
          @keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
          .blood-type{font-weight:700;font-size:1.1rem;color:var(--primary-color);}
          .appointment-time{font-weight:600;color:var(--nurse-color);}
          @media(max-width:768px){.container{padding:10px;}table{font-size:.85rem;}th,td{padding:10px 8px;}.btn{padding:6px 12px;font-size:.8rem;}.profile-img{width:40px;height:40px;}}
          </style>
          
</head>

<div class="container">
  <!-- Page Header -->
  <div class="page-header">
    <h1>
      <i class="fas fa-user-nurse"></i>
      My Donation Appointments
    </h1>
    <p class="mb-0">Manage and process donor appointments assigned to you</p>
  </div>

  <!-- Messages Container -->
  <div id="nurse-messages" class="message-container"></div>

  <!-- Search Section -->
  <div class="search-section">
    <label for="donationSearch" class="form-label fw-bold">
      <i class="fas fa-search"></i> Search Appointments
    </label>
    <input type="search" id="donationSearch" class="form-control search-input" 
           placeholder="Search by donor name, blood group, contact, status...">
    <small class="form-text text-muted mt-2">
      <i class="fas fa-info-circle"></i> Type to filter appointments in real-time
    </small>
  </div>

  {% if donor_donations %}
  <div class="table-container">
    <div style="max-height: 600px; overflow-y: auto;">
      <table class="table table-hover align-middle">
        <thead>
          <tr>
            <th><i class="fas fa-user"></i> Donor Info</th>
            <th><i class="fas fa-id-card"></i> Identity</th>
            <th><i class="fas fa-home"></i> Contact & Address</th>
            <th><i class="fas fa-camera"></i> Photo</th>
            <th><i class="fas fa-tint"></i> Blood Details</th>
            <th><i class="fas fa-hospital"></i> Center</th>
            <th><i class="fas fa-calendar-alt"></i> Appointment</th>
            <th><i class="fas fa-flag"></i> Status</th>
            <th><i class="fas fa-cogs"></i> Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for appointment in donor_donations %}
          {% with blood_donate=appointment.request %}
          <tr id="appointment-row-{{ appointment.id }}" data-appointment-id="{{ appointment.id }}">
            <!-- Donor Info -->
            <td>
              <div class="donor-info">
                <div class="donor-name">{{ appointment.donor.user.get_full_name|default:"N/A" }}</div>
                <div class="donor-details">
                  {% if blood_donate.donor_age %}
                    Age: {{ blood_donate.donor_age }} years
                  {% else %}
                    Age: N/A
                  {% endif %}
                </div>
              </div>
            </td>

            <!-- Identity -->
            <td>
              <div class="fw-bold">{{ appointment.donor.national_id|default:"No ID" }}</div>
            </td>

            <!-- Contact & Address -->
            <td>
              <div>
                <i class="fas fa-phone"></i> {{ appointment.donor.mobile|default:"N/A" }}
              </div>
              <div class="text-muted mt-1">
                <i class="fas fa-map-marker-alt"></i> {{ appointment.donor.address|default:"N/A" }}
              </div>
            </td>

            <!-- Profile Picture -->
            <td>
              {% if appointment.donor.profile_pic %}
                <img src="{{ appointment.donor.profile_pic.url }}" 
                     alt="Profile Picture of {{ appointment.donor.user.get_full_name }}"
                     class="profile-img" />
              {% else %}
                <div class="d-flex align-items-center justify-content-center profile-img bg-light text-muted">
                  <i class="fas fa-user"></i>
                </div>
              {% endif %}
            </td>

            <!-- Blood Details -->
            <td>
              <div class="blood-type">{{ blood_donate.bloodgroup|default:"N/A" }}</div>
              <div class="text-muted">{{ blood_donate.unit|default:"N/A" }} ml</div>
            </td>

            <!-- Donation Center -->
            <td>
              <div class="fw-bold">
                {% if blood_donate.donation_center %}
                  {{ blood_donate.donation_center.name }}
                {% else %}
                  <span class="text-muted">Not specified</span>
                {% endif %}
              </div>
            </td>

            <!-- Appointment Time -->
            <td>
              <div class="appointment-time">{{ appointment.date|date:"M d, Y" }}</div>
              <div class="text-muted">{{ appointment.date|date:"h:i A" }}</div>
            </td>

            <!-- Status -->
            <td>
              <span class="status-badge status-{{ appointment.status }}">
                {{ appointment.status|title }}
              </span>
            </td>

            <!-- Actions -->
            <td>
              {% if appointment.status in "completed,cancelled,rejected" %}
                <div class="text-muted">
                  <i class="fas fa-lock"></i>
                  <em>No actions available</em>
                </div>
              {% else %}
                <div class="action-buttons">
                  {% if appointment.status == "pending" %}
                    <button class="btn btn-success update-status-btn"
                            data-id="{{ appointment.id }}" 
                            data-action="approve"
                            data-original-text="<i class='fas fa-check'></i> Approve">
                      <i class="fas fa-check"></i> Approve
                    </button>
                    <button class="btn btn-danger update-status-btn"
                            data-id="{{ appointment.id }}" 
                            data-action="reject"
                            data-original-text="<i class='fas fa-times'></i> Reject">
                      <i class="fas fa-times"></i> Reject
                    </button>
                    <button class="btn btn-secondary update-status-btn"
                            data-id="{{ appointment.id }}" 
                            data-action="cancelled"
                            data-original-text="<i class='fas fa-ban'></i> Cancel">
                      <i class="fas fa-ban"></i> Cancel
                    </button>
                  {% elif appointment.status == "approved" %}
                    <button class="btn btn-info"
                            data-bs-toggle="modal" 
                            data-bs-target="#completeModal-{{ appointment.id }}">
                      <i class="fas fa-check-double"></i> Complete
                    </button>
                    <button class="btn btn-secondary update-status-btn"
                            data-id="{{ appointment.id }}" 
                            data-action="cancelled"
                            data-original-text="<i class='fas fa-ban'></i> Cancel">
                      <i class="fas fa-ban"></i> Cancel
                    </button>
                  {% endif %}
                </div>
              {% endif %}
            </td>
          </tr>

         <!-- Completion Modal -->
<div class="modal fade" id="completeModal-{{ appointment.id }}" tabindex="-1"
aria-labelledby="completeModalLabel-{{ appointment.id }}" aria-hidden="true">
<div class="modal-dialog modal-lg">
<form method="post" class="complete-form" data-id="{{ appointment.id }}">
 {% csrf_token %}
 <input type="hidden" name="action" value="completed" />
 <div class="modal-content">
   <div class="modal-header">
     <h5 class="modal-title">
       <i class="fas fa-check-double"></i>
       Complete Donation - {{ appointment.donor.user.get_full_name }}
     </h5>
     <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
   </div>
   <div class="modal-body">
     <div class="alert alert-info">
       <i class="fas fa-info-circle"></i>
       <strong>Donor:</strong> {{ appointment.donor.user.get_full_name }}<br>
       <strong>Appointment:</strong> {{ appointment.date|date:"M d, Y h:i A" }}<br>
       <strong>Center:</strong> {{ blood_donate.donation_center.name|default:"N/A" }}
     </div>

     <!-- Message container for success or error alerts -->
     <div class="modal-message"></div>

     <div class="row g-3">
       <div class="col-md-6">
         <label for="bloodgroup-{{ appointment.id }}" class="form-label fw-bold">
           <i class="fas fa-tint"></i> Blood Group *
         </label>
         <select name="bloodgroup" id="bloodgroup-{{ appointment.id }}" class="form-select" required>
           <option value="">Select blood group</option>
           {% for bg_value, bg_label in blood_group_choices %}
             <option value="{{ bg_value }}"
               {% if blood_donate.bloodgroup == bg_value %}selected{% endif %}>
               {{ bg_label }}
             </option>
           {% endfor %}
         </select>
       </div>
       <div class="col-md-6">
         <label for="unit-{{ appointment.id }}" class="form-label fw-bold">
           <i class="fas fa-flask"></i> Units (ml) *
         </label>
         <input type="number" name="unit" min="450" max="2700" step="50"
                id="unit-{{ appointment.id }}" class="form-control"
                value="{{ blood_donate.unit|default:450 }}" required>
       </div>
       <div class="col-md-6">
         <label class="form-label fw-bold">
           <i class="fas fa-barcode"></i> Blood Bag Barcode
         </label>
         <input type="text" class="form-control bg-light" 
                value="Will be auto-generated on completion" readonly>
         <div class="form-text">Barcode is created automatically by the system.</div>
       </div>
       <div class="col-md-6">
         <label class="form-label fw-bold">
           <i class="fas fa-calendar-day"></i> Expiry Date
         </label>
         <input type="text" class="form-control" 
                value="{{ appointment.date|date:'M d, Y'|default:'' }} + 46 days" readonly>
         <div class="form-text">Automatically calculated (46 days shelf life)</div>
       </div>
     </div>
   </div>
   <div class="modal-footer">
     <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
       <i class="fas fa-times"></i> Cancel
     </button>
     <button type="submit" class="btn btn-info">
       <i class="fas fa-check"></i> Confirm & Complete
     </button>
   </div>
 </div>
</form>
</div>
</div>

          {% endwith %}
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% else %}
    <div class="table-container">
      <div class="no-data">
        <i class="fas fa-calendar-times"></i>
        <h4>No Appointments Found</h4>
        <p class="text-muted mb-0">You don't have any donation appointments assigned to you at this time.</p>
      </div>
    </div>
  {% endif %}
</div>


<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // CSRF Token helper
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  // Enhanced message display with auto-dismiss
  function showMessage(type, message, autoHide = true) {
    const container = document.getElementById('nurse-messages');
    const alertId = 'alert-' + Date.now();
    
    container.innerHTML = `
      <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
        <i class="fas ${getIconForType(type)}"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>`;
    
    container.scrollIntoView({ behavior: "smooth", block: "start" });
    
    if (autoHide && type === 'success') {
      setTimeout(() => {
        const alert = document.getElementById(alertId);
        if (alert) {
          bootstrap.Alert.getOrCreateInstance(alert).close();
        }
      }, 3000);
    }
  }

  function getIconForType(type) {
    const icons = {
      'success': 'fa-check-circle',
      'danger': 'fa-exclamation-circle',
      'warning': 'fa-exclamation-triangle',
      'info': 'fa-info-circle'
    };
    return icons[type] || 'fa-info-circle';
  }

  // Enhanced search functionality
  const searchInput = document.getElementById('donationSearch');
  const tableRows = document.querySelectorAll('tr[data-appointment-id]');
  
  searchInput.addEventListener('input', function() {
    const query = this.value.toLowerCase().trim();
    let visibleCount = 0;
    
    tableRows.forEach(row => {
      const text = row.textContent.toLowerCase();
      const shouldShow = query === '' || text.includes(query);
      
      row.style.display = shouldShow ? '' : 'none';
      if (shouldShow) visibleCount++;
      
      if (shouldShow && query !== '') {
        row.style.backgroundColor = '#e8f7ff';
        setTimeout(() => {
          row.style.backgroundColor = '';
        }, 2000);
      }
    });
    
    // Handle no results message
    handleNoResultsMessage(visibleCount, query);
  });

  function handleNoResultsMessage(visibleCount, query) {
    const existingMsg = document.querySelector('.no-search-results');
    
    if (visibleCount === 0 && query !== '' && !existingMsg) {
      const tbody = document.querySelector('.table tbody');
      const noResultsRow = document.createElement('tr');
      noResultsRow.className = 'no-search-results';
      noResultsRow.innerHTML = `
        <td colspan="9">
          <div class="no-data">
            <i class="fas fa-search"></i>
            <h5>No Results Found</h5>
            <p class="text-muted mb-0">No appointments match your search: "${query}"</p>
          </div>
        </td>
      `;
      tbody.appendChild(noResultsRow);
    } else if (visibleCount > 0 && existingMsg) {
      existingMsg.remove();
    }
  }

  // Enhanced confirmation messages
  function getConfirmationMessage(action, donorName) {
    const messages = {
      'approve': `Approve the donation appointment for ${donorName}?\n\nThis will allow the donation to proceed to completion.`,
      'reject': `Reject the donation appointment for ${donorName}?\n\nThe donor will be notified and may need to reschedule.`,
      'cancelled': `Cancel the donation appointment for ${donorName}?\n\nThis action cannot be undone and the donor will be notified.`,
      'completed': `Mark the donation for ${donorName} as completed?\n\nThis will finalize the donation and update blood stock levels.`
    };
    return messages[action] || `${action} this appointment for ${donorName}?`;
  }

  // Status update buttons with enhanced error handling
  document.querySelectorAll('.update-status-btn').forEach(button => {
    button.addEventListener('click', () => {
      const appointmentId = button.dataset.id;
      const action = button.dataset.action;
      const donorName = button.closest('tr').querySelector('.donor-name').textContent;
      const originalText = button.dataset.originalText;
      
      if(!confirm(getConfirmationMessage(action, donorName))) return;

      // Disable button and show loading
      button.disabled = true;
      button.innerHTML = '<span class="loading-spinner"></span> Processing...';

      fetch(`/nurse/appointment/${appointmentId}/update_status/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams({ action: action })
      })
      .then(res => {
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        return res.json();
      })
      .then(data => {
        if(data.success){
          showMessage("success", `Success: ${data.message}`);
          
          // Update UI immediately
          updateRowStatus(appointmentId, data.status);
          
          // Reload after delay for full sync
          setTimeout(() => location.reload(), 2000);
        } else {
          showMessage("danger", `Error: ${data.error}`, false);
          resetButton(button, originalText);
        }
      })
      .catch((error) => {
        console.error('Request failed:', error);
        showMessage("danger", `Network error: ${error.message}`, false);
        resetButton(button, originalText);
      });
    });
  });

  function resetButton(button, originalText) {
    button.disabled = false;
    button.innerHTML = originalText;
  }

  function updateRowStatus(appointmentId, newStatus) {
    const row = document.getElementById(`appointment-row-${appointmentId}`);
    if (row) {
      const statusBadge = row.querySelector('.status-badge');
      if (statusBadge) {
        statusBadge.className = `status-badge status-${newStatus}`;
        statusBadge.textContent = newStatus.charAt(0).toUpperCase() + newStatus.slice(1);
      }
    }
  }

  // Completion form handling
  document.querySelectorAll('.complete-form').forEach(form => {
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const appointmentId = form.dataset.id;
      const formData = new FormData(form);
      const donorName = form.closest('.modal').querySelector('.modal-title').textContent.split(' - ')[1];
      
      if(!confirm(getConfirmationMessage('completed', donorName))) return;

      const submitBtn = form.querySelector('button[type="submit"]');
      const originalText = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="loading-spinner"></span> Processing...';

      fetch(`/nurse/appointment/${appointmentId}/update_status/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken') },
        body: formData
      })
      .then(res => {
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        return res.json();
      })
      .then(data => {
        if(data.success){
          showMessage("success", `Success: ${data.message}`);
          
          // Close modal and reload
          const modalEl = document.getElementById(`completeModal-${appointmentId}`);
          const modal = bootstrap.Modal.getInstance(modalEl);
          if (modal) {
            modal.hide();
          }
          
          setTimeout(() => location.reload(), 2000);
        } else {
          showMessage("danger", `Error: ${data.error}`, false);
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalText;
        }
      })
      .catch((error) => {
        console.error('Request failed:', error);
        showMessage("danger", `Network error: ${error.message}`, false);
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
      });
    });
  });

  // Auto-refresh every 5 minutes when page is visible
  setInterval(() => {
    if (document.visibilityState === 'visible') {
      console.log('Auto-refreshing appointments...');
      window.location.reload();
    }
  }, 300000); // 5 minutes

  // Show loading indicator on page unload
  window.addEventListener('beforeunload', () => {
    document.body.style.opacity = '0.7';
  });
});
</script>

{% endblock %}