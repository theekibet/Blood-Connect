{% extends 'nurse/nursebase.html' %}
{% load static %}

{% block content %}
<style>.dashboard-container{max-width:900px;margin:2rem auto;padding:0 1rem;}.welcome-card{border-radius:10px;box-shadow:0 0 10px rgba(0,0,0,0.1);padding:1rem 1.5rem;margin-bottom:1.5rem;background:#fff;display:flex;align-items:center;gap:1.5rem;transition:transform 0.3s ease;}.welcome-card:hover{transform:scale(1.03);}.nurse-avatar{width:80px;height:80px;border-radius:50%;object-fit:cover;border:3px solid #e9ecef;flex-shrink:0;}.avatar-placeholder{width:80px;height:80px;display:flex;align-items:center;justify-content:center;color:#6c757d;background:#e9ecef;border-radius:50%;font-size:3.5rem;flex-shrink:0;}.welcome-text h1{font-weight:700;font-size:1.75rem;margin-bottom:0.15rem;color:#343a40;}.welcome-text .donation-center{display:flex;align-items:center;gap:6px;font-size:1rem;color:#555;}.welcome-text .donation-center i{color:#007bff;}.welcome-text .not-assigned{color:#dc3545;font-weight:600;}.alert-warning{max-width:700px;margin:1rem auto 2rem;}.card{max-width:700px;margin:1.5rem auto;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1);}.card-header{font-weight:600;font-size:1.25rem;background-color:#f8f9fa;border-bottom:1px solid #ddd;}.card-body{padding:1.5rem;}.btn-primary{background-color:#ff0018;border-color:#ff0018;transition:background-color 0.3s ease;font-weight:600;}.btn-primary:hover,.btn-primary:focus{background-color:#cc0013;border-color:#cc0013;}.btn-primary i{margin-right:0.5rem;}.table-striped tbody tr:nth-of-type(odd){background-color:#f8f9fa;}.table-danger{background-color:#f8d7da !important;}@media (max-width:575.98px){.welcome-card{flex-direction:column;text-align:center;}.welcome-text .donation-center{justify-content:center;margin-top:0.3rem;}}</style>

<div class="dashboard-container">

  <!-- Welcome Section -->
 <!-- Welcome Section -->
<div class="welcome-card">
  {% if nurse.profile_pic %}
    <img src="{{ nurse.profile_pic.url }}" alt="Nurse Avatar" class="nurse-avatar">
  {% else %}
    <div class="avatar-placeholder"><i class="fas fa-user-md"></i></div>
  {% endif %}
  <div class="welcome-text">
    <h1>Welcome, Nurse {{ nurse.full_name }}</h1>


    <div class="donation-center">
      <i class="fas fa-map-marker-alt"></i>
      {% if nurse.donation_center %}
        {{ nurse.donation_center.name }}
      {% else %}
        <span class="not-assigned">Not assigned to any center</span>
      {% endif %}
    </div>
    <div class="registration-number mt-1" style="display: flex; align-items: center; gap: 6px; font-size: 1rem; color: #555;">
      <i class="fas fa-id-badge" style="color: #007bff;"></i>
      <span>Reg. Number: {{ nurse.registration_number|default:"N/A" }}</span>
    </div>
  </div>
</div>

{% if today_appointments == 0 %}
  <div class="alert alert-warning" role="alert">You have no appointments scheduled today.</div>
{% endif %}


  <!-- Overview Card -->
  <div class="card">
    <div class="card-header">Dashboard Overview</div>
    <div class="card-body">
      <p><strong>Total Appointments:</strong> {{ total_appointments }}</p>
      <p><strong>Today's Appointments:</strong> {{ today_appointments }}</p>
      {% if next_appointment %}
      <p><strong>Next Appointment:</strong> {{ next_appointment.date|date:"M d, Y" }} at {{ next_appointment.date|time:"H:i" }}</p>
      {% endif %}
      <a href="#" onclick="return false;" class="btn btn-primary mt-2">
        <i class="fas fa-calendar-check"></i> View Appointments
      </a>
    </div>
  </div>

  <!-- Chart Card -->
  <div class="card">
    <div class="card-header">Weekly Appointment Trend</div>
    <div class="card-body">
      <canvas id="appointmentsChart" height="100"></canvas>
    </div>
  </div>

  <!-- Blood Stock Summary Section -->
  {% if blood_stock_totals %}
  <div class="card mt-4">
    <div class="card-header">Blood Stock Summary - {{ nurse.donation_center.name }}</div>
    <div class="card-body p-3">
      <table class="table table-striped table-sm">
        <thead>
          <tr>
            <th>Blood Group</th>
            <th>Total Units (ml)</th>
            <th>Earliest Expiry</th>
            <th>Batches</th>
          </tr>
        </thead>
        <tbody>
          {% for group in blood_stock_totals %}
          <tr {% if group.earliest_expiry and group.earliest_expiry <= today_date|add:"7 days" %}class="table-danger"{% endif %}>
            <td>{{ group.bloodgroup }}</td>
            <td>{{ group.total_units }}</td>
            <td>{{ group.earliest_expiry|date:"M d, Y" }}</td>
            <td>{{ group.batches_count }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

</div>

<!-- Chart Script  -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const ctx = document.getElementById('appointmentsChart').getContext('2d');
  const appointmentsChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: {{ chart_labels|safe }},
      datasets: [{
        label: 'Appointments',
        data: {{ chart_data|safe }},
        backgroundColor: 'rgba(220,53,69,0.1)',
        borderColor: '#dc3545',
        borderWidth: 3,
        tension: 0.4,
        pointBackgroundColor: '#fff',
        pointBorderColor: '#dc3545',
        fill: true,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: { y: { beginAtZero: true, stepSize: 1 } },
      plugins: { legend: { display: false } }
    }
  });
</script>
{% endblock %}
