{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Blood Connect</title>
<meta content="width=device-width, initial-scale=1.0" name="viewport">
<link rel="icon" href="{% static 'app/img/favicon.ico' %}">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/all.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet" />
<link href="{% static 'lib/owlcarousel/assets/owl.carousel.min.css' %}" rel="stylesheet" />
<link href="{% static 'lib/tempusdominus/css/tempusdominus-bootstrap-4.min.css' %}" rel="stylesheet" />
<link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet" />
<link href="{% static 'css/styles.css' %}" rel="stylesheet" />
<style>
    body,html{margin:0;padding:0;font-family:'Roboto',sans-serif;background:linear-gradient(135deg,#e0f2f1,#c8e6c9);color:#2d2d2d;min-height:100vh}
    .container{max-width:1140px}
    #section-jumbotron{background:linear-gradient(135deg,#d32f2f,#f48fb1);color:#fff;padding:90px 25px;text-align:center;box-shadow:inset 0 0 80px rgba(0,0,0,.25);font-weight:700;font-size:2.5rem;border-radius:0 0 50px 50px;user-select:none;margin-bottom:1.5rem}
    #section-jumbotron p.lead{font-size:1.25rem;font-weight:500;margin-top:.5rem}
    .icon-buttons-container{margin:40px 0 30px;display:flex;justify-content:center;align-items:center;gap:24px;flex-wrap:wrap}
    #sos-button{background:linear-gradient(135deg,#d32f2f,#f48fb1);border:none;padding:18px 44px;font-size:1.8rem;font-weight:700;color:#fff;border-radius:50px;cursor:pointer;display:inline-flex;align-items:center;gap:12px;box-shadow:0 8px 25px rgba(211,47,47,.5);transition:background .3s ease,box-shadow .3s ease;user-select:none;animation:soft-glow 3s ease-in-out infinite;}
    #sos-button:hover,#sos-button:focus{animation:none;filter:brightness(1.1);box-shadow:0 12px 32px rgba(183,28,28,.75);outline:none}
    #sos-button i{font-size:1.8rem}
    #sos-message{color:#d32f2f;font-weight:600;margin-top:12px;min-height:26px;text-align:center}
    #ai-bot-fab-mini{font-size:2.8rem;color:#d32f2f;cursor:pointer;transition:color .3s ease;user-select:none;display:inline-flex;align-items:center;justify-content:center;border-radius:50%;width:58px;height:58px;box-shadow:0 6px 22px rgba(211,47,47,.4);animation:soft-glow 3s ease-in-out infinite;}
    #ai-bot-fab-mini:hover,#ai-bot-fab-mini:focus{animation:none;color:#b71c1c;box-shadow:0 10px 30px rgba(183,28,28,.75);outline:none}
    .section-card{background:#fff;border-radius:18px;padding:40px 30px;box-shadow:0 10px 28px rgba(211,47,47,.1);transition:box-shadow .3s ease;height:100%;display:flex;flex-direction:column;justify-content:space-between}
    .section-card:hover,.section-card:focus-within{box-shadow:0 16px 36px rgba(211,47,47,.3);outline:none}
    .section-card h3{font-weight:700;color:#b71c1c;margin-bottom:15px}
    .section-card p{flex-grow:1;font-size:1rem;color:#4a4a4a;line-height:1.5}
    .section-card a.btn{align-self:flex-start;margin-top:20px;font-weight:700;font-size:1rem;padding:12px 28px;box-shadow:0 5px 16px rgba(211,47,47,.2);text-decoration:none}
    .section-card a.btn:hover,.section-card a.btn:focus{outline:none;box-shadow:0 8px 25px rgba(211,47,47,.4)}
    .impact-section{margin:60px auto 80px;max-width:900px;background:linear-gradient(135deg,#d32f2f,#f48fb1);border-radius:22px;box-shadow:0 18px 55px rgba(211,47,47,.4);padding:50px 35px;color:#fff;text-align:center}
    .impact-section h2{font-size:2.2rem;font-weight:900;margin-bottom:24px}
    .impact-section p{font-size:1.2rem;line-height:1.7;max-width:700px;margin:0 auto 30px}
    .impact-section a.btn{background:#fff;color:#d32f2f;font-weight:900;font-size:1.1rem;border-radius:50px;padding:14px 38px;display:inline-flex;align-items:center;gap:10px;box-shadow:0 8px 28px rgba(211,47,47,.3);transition:background-color .3s ease;text-decoration:none}
    .impact-section a.btn:hover,.impact-section a.btn:focus{background-color:#f8bbd0;color:#b71c1c;outline:none}
    .impact-section a.btn i{font-size:1.6rem}
    @media(max-width:991.98px){.section-card{padding:35px 25px}.impact-section{padding:40px 25px}}
    @media(max-width:575.98px){.section-card{padding:30px 18px}.impact-section{padding:30px 18px}#sos-button{font-size:1.4rem;padding:14px 28px;margin-right:0;margin-bottom:16px;width:100%;justify-content:center}.icon-buttons-container{flex-direction:column;gap:16px}#ai-bot-fab-mini{width:50px;height:50px;font-size:2rem}}
    @keyframes soft-glow{0%,100%{box-shadow:0 0 8px rgba(211,47,47,0.4);filter:brightness(0.9)}50%{box-shadow:0 0 16px rgba(211,47,47,0.7);filter:brightness(1)}}
    #chatbox{display:none;position:fixed;bottom:90px;right:20px;width:320px;height:420px;background:#fff;border-radius:14px;box-shadow:0 8px 22px rgba(0,0,0,0.25);flex-direction:column;overflow:hidden;z-index:9999;font-family:'Roboto',sans-serif}
    #chatbox-header{background:#d32f2f;color:#fff;padding:12px 20px;display:flex;justify-content:space-between;align-items:center;font-weight:700;font-size:1.1rem}
    #chatbox-close{background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer}
    #chat_response{flex-grow:1;overflow-y:auto;padding:15px;font-size:0.95rem;line-height:1.4;outline:none}
    #user_input{width:100%;border:none;border-top:1px solid #ddd;padding:10px 16px;font-size:1rem;resize:none;outline:none}
    #chatbox button{background:#d32f2f;border:none;color:#fff;padding:10px 20px;cursor:pointer;font-weight:700;transition:background-color 0.3s}
    #chatbox button:hover,#chatbox button:focus{background:#b71c1c;outline:none}
    
    </style>
</head>
<body>
{% include "blood/navbar.html" %}

<section id="section-jumbotron" class="jumbotron jumbotron-fluid d-flex justify-content-center align-items-center xyz" role="banner">
    <div class="container text-center" role="heading" aria-level="1">
        <h1 class="display-4">Welcome to Blood Connect</h1>
        <p class="lead mt-3">The future of safe, reliable blood donation</p>
    </div>
</section>

<div class="container icon-buttons-container" aria-label="Emergency and assistance options">
    <button id="sos-button" class="btn btn-danger" title="Find Nearest Donation Center" aria-describedby="sos-message" aria-label="SOS, find nearest donation center">
        <i class="fas fa-exclamation-triangle" aria-hidden="true"></i> SOS - 
        Nearest Donation Center
    </button>
    <i id="ai-bot-fab-mini" class="fas fa-robot" title="Chat with AI Assistant" aria-label="Open AI assistant chatbot" tabindex="0" role="button"></i>
    <div id="sos-message" role="alert" aria-live="assertive" aria-atomic="true"></div>
</div>

<div class="container">
    <div class="row g-4 justify-content-center">
        <div class="col-lg-6 col-md-10">
            <section class="about-us-section section-card" tabindex="0" aria-labelledby="about-us-heading">
                <h3 id="about-us-heading">About Us</h3>
                <p>Learn more about our mission and values.</p>
                <p>We are dedicated to providing a safe and efficient blood donation process, ensuring that every drop counts in saving lives.</p>
                <a href="{% url 'about-us' %}" class="btn" role="link">Read More</a>
            </section>
        </div>
        <div class="col-lg-6 col-md-10">
            <section class="contact-us-section section-card" tabindex="0" aria-labelledby="contact-us-heading">
                <h3 id="contact-us-heading">Contact Us</h3>
                <p>Get in touch with us for any inquiries.</p>
                <p>Phone: <a href="tel:+254781024762" class="text-decoration-none">+254 781 024 762</a><br />
                    Email: <a href="mailto:allankibet1820@gmail.com" class="text-decoration-none">allankibet1820@gmail.com</a></p>
                <a href="{% url 'contact' %}" class="btn" role="link">Click to Send Admin Message</a>
            </section>
        </div>
    </div>
    <div class="row justify-content-center mt-3">
        <div class="col-md-6 col-lg-4">
            <section class="volunteer-section section-card" tabindex="0" aria-labelledby="volunteer-heading">
                <h3 id="volunteer-heading">Volunteer</h3>
                <p>Join our team of volunteers and make a difference.</p>
                <a href="#" class="btn" role="link">Volunteer Today</a>
            </section>
        </div>
    </div>
</div>

<section class="impact-section" aria-label="How your donation helps sickle cell patients">
    <div class="container">
        <h2>How Your Donation Helps Sickle Cell Patients</h2>
        <p>Sickle cell disease causes red blood cells to become misshapen and block blood flow, leading to severe pain and complications. Your blood donation provides healthy red blood cells that improve oxygen delivery, reduce painful crises, and prevent life-threatening complications.</p>
        <a href="{% url 'sickle_cell' %}" class="btn" role="link">See your impact <i class="fas fa-heartbeat ms-2"></i></a>
    </div>
</section>

{% include "blood/footer.html" %}

<!-- Chatbot Widget -->
<div id="chatbox" role="region" aria-label="Chatbot">
    <div id="chatbox-header">
        <span>AI Assistant</span>
        <button id="chatbox-close" aria-label="Close Chatbot">&times;</button>
    </div>
    <div id="chat_response" tabindex="0" aria-live="polite" aria-atomic="true"></div>
    <textarea id="user_input" placeholder="Ask a question..." aria-label="Type your message"></textarea>
    <button onclick="sendMessage()" aria-label="Send message">Send</button>
</div>

<script>
    document.getElementById('sos-button').addEventListener('click', function () {
        const messageElem = document.getElementById('sos-message');
        messageElem.style.display = 'none';
        messageElem.innerText = '';
    
        if (!navigator.geolocation) {
            messageElem.innerText = "Geolocation is not supported by your browser.";
            messageElem.style.display = 'block';
            return;
        }
    
        navigator.geolocation.getCurrentPosition(success, error, { timeout: 10000 });
    
        function success(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            const isLoggedIn = {{ user.is_authenticated|yesno:"true,false" }};
    
            if (isLoggedIn) {
                fetch("{% url 'save-user-location' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: `latitude=${lat}&longitude=${lon}`
                })
                .then(r => r.json())
                .then(data => {
                    if (data.status === 'success') {
                        window.location.href = "{% url 'nearby-centers' %}";
                    } else {
                        messageElem.innerText = data.message || "Failed to save location.";
                        messageElem.style.display = 'block';
                    }
                })
                .catch(err => {
                    messageElem.innerText = "Error saving location. Please try again.";
                    messageElem.style.display = 'block';
                    console.error('Error:', err);
                });
            } else {
                // Guest users go directly with lat/lng params
                window.location.href = `{% url 'nearby-centers' %}?lat=${lat}&lng=${lon}`;
            }
        }
    
        function error(err) {
            switch (err.code) {
                case err.PERMISSION_DENIED:
                    messageElem.innerText = "Permission denied. Please allow location access.";
                    break;
                case err.POSITION_UNAVAILABLE:
                    messageElem.innerText = "Location information is unavailable.";
                    break;
                case err.TIMEOUT:
                    messageElem.innerText = "Location request timed out.";
                    break;
                default:
                    messageElem.innerText = "An unknown error occurred.";
            }
            messageElem.style.display = 'block';
        }
    });
    
    document.getElementById('ai-bot-fab-mini').addEventListener('click', function () {
        const chatbox = document.getElementById('chatbox');
        if (chatbox.style.display === 'flex') {
            chatbox.style.display = 'none';
            return;
        }
        chatbox.style.display = 'flex';
        document.getElementById('user_input').focus();
    });
    
    document.getElementById('chatbox-close').addEventListener('click', function () {
        document.getElementById('chatbox').style.display = 'none';
    });
    
    const chatResponse = document.getElementById('chat_response');
    const userInput = document.getElementById('user_input');
    
    userInput.addEventListener('keydown', function (e) {
        if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    
    function appendMessage(text, className) {
        const div = document.createElement('div');
        div.className = className;
        div.innerText = text;
        chatResponse.appendChild(div);
        chatResponse.scrollTop = chatResponse.scrollHeight;
    }
    
    function sendMessage() {
        const message = userInput.value.trim();
        if (!message) {
            appendMessage("Please enter a message.", "bot-message");
            return;
        }
        appendMessage("You: " + message, "user-message");
        appendMessage("Thinking...", "bot-message");
        userInput.value = "";
        userInput.disabled = true;
    
        fetch("/api/chatbot/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: message })
        })
        .then(r => r.json())
        .then(data => {
            const lastBotMsg = [...chatResponse.querySelectorAll('.bot-message')].pop();
            if (lastBotMsg && lastBotMsg.innerText === "Thinking...") lastBotMsg.remove();
            if (data.reply) appendMessage(data.reply, "bot-message");
            else if (data.error) appendMessage("Error: " + data.error, "bot-message");
            userInput.disabled = false;
            userInput.focus();
        })
        .catch(error => {
            const lastBotMsg = [...chatResponse.querySelectorAll('.bot-message')].pop();
            if (lastBotMsg && lastBotMsg.innerText === "Thinking...") lastBotMsg.remove();
            appendMessage("An error occurred. Try again.", "bot-message");
            console.error("Chatbot error:", error);
            userInput.disabled = false;
            userInput.focus();
        });
    }
    </script>
    

<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="{% static 'lib/easing/easing.min.js' %}"></script>
<script src="{% static 'lib/waypoints/waypoints.min.js' %}"></script>
<script src="{% static 'lib/counterup/counterup.min.js' %}"></script>
<script src="{% static 'lib/owlcarousel/owl.carousel.min.js' %}"></script>
<script src="{% static 'lib/tempusdominus/js/moment.min.js' %}"></script>
<script src="{% static 'lib/tempusdominus/js/moment-timezone.min.js' %}"></script>
<script src="{% static 'lib/tempusdominus/js/tempusdominus-bootstrap-4.min.js' %}"></script>
<script src="{% static 'js/main.js' %}"></script>
</body>
</html>
