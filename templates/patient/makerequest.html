{% extends 'patient/patientbase.html' %}
{% load static %}
{% load widget_tweaks %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />

<script>const centerData = JSON.parse('{{ center_data_json|escapejs }}');</script>

<style>
  body { background: linear-gradient(135deg, #ff4b1f, #1fddff); font-family: 'Segoe UI', Tahoma, sans-serif; color: #333; }
  .container { max-width: 960px; margin: 40px auto; display: flex; flex-wrap: wrap; gap: 30px; }
  .card { background: #fff; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); padding: 30px; flex: 1 1 450px; }
  .title { font-size: 1.8rem; margin-bottom: 25px; color: #ff4b1f; display: flex; align-items: center; gap: 12px; font-weight: 700; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
  .form-row { display: flex; flex-direction: column; margin-bottom: 20px; }
  .form-row .name { font-weight: 600; margin-bottom: 6px; color: #ff4b1f; display: flex; align-items: center; gap: 8px; font-size: 1rem; }
  .input--style-5 { width: 100%; padding: 10px 14px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem; transition: border-color 0.3s ease; }
  .input--style-5:focus { outline: none; border-color: #ff4b1f; box-shadow: 0 0 8px #ff4b1faa; }
  .errorlist { list-style: none; padding-left: 0; margin-top: 6px; color: #d93025; }
  .errorlist li { display: flex; align-items: center; gap: 6px; font-size: 0.9rem; }
  .btn { background: linear-gradient(135deg,#ff4b1f,#ff9068); color: white; border: none; padding: 12px 28px; border-radius: 30px; font-weight: 700; font-size: 1.1rem; cursor: pointer; display: inline-flex; align-items: center; gap: 10px; justify-content: center; transition: background 0.3s; }
  .btn:hover { background: linear-gradient(135deg,#e03e16,#ff7043); }
  #timeSlots label { display: inline-block; margin: 5px 8px 0 0; cursor: pointer; font-weight: 600; color: #555; user-select: none; }
  #timeSlots input[type="radio"] { margin-right: 6px; accent-color: #ff4b1f; cursor: pointer; }
  #timeSlots label.disabled { color: #999; cursor: not-allowed; }
  #summaryBox { margin-top: 20px; background: #ff4b1f1a; border: 1.5px solid #ff4b1f; border-radius: 10px; padding: 15px 20px; font-weight: 600; color: #ff4b1f; font-size: 1.1rem; display: none; line-height: 1.4; }
  @media (max-width: 768px) { .container { flex-direction: column; padding: 20px; } }
</style>
<div class="container">
  <!-- Request Form Card -->
  <div class="card">
    <h2 class="title"><i class="fa-solid fa-droplet"></i> Request Blood & Book Appointment</h2>

    {% if pending_request %}
      <div class="alert alert-warning">
        <i class="fa-solid fa-triangle-exclamation"></i>
        You already have a pending blood request. Please wait for it to be approved or declined before making a new request.
      </div>
    {% else %}

    {% if messages %}
      {% for message in messages %}
        <div class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %}">
          {{ message }}
        </div>
      {% endfor %}
    {% endif %}

    <form method="POST" enctype="multipart/form-data" novalidate>
      {% csrf_token %}
    
      <!-- Non-field errors from RequestForm -->
      {% if request_form.non_field_errors %}
        <div class="alert alert-danger">
          <ul>
            {% for error in request_form.non_field_errors %}
              <li>{{ error }}</li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}
    
      <!-- Non-field errors passed explicitly via form_errors -->
      {% if form_errors.non_field_errors %}
        <div class="alert alert-danger">
          <ul>
            {% for error in form_errors.non_field_errors %}
              <li>{{ error }}</li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}
    
      <!-- Appointment validation errors (from model full_clean) -->
      {% if form_errors.appointment %}
        <div class="alert alert-danger">
          <ul>
            {% for error in form_errors.appointment %}
              <li>{{ error }}</li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}
    
      <!-- Loop through fields and render with per-field errors -->
      {% for field in request_form %}
        <div class="form-row {% if field.errors %}has-error{% endif %}">
          <div class="name">
            {% if field.name == 'donation_center' %}<i class="fa-solid fa-house-medical"></i>
            {% elif field.label == 'Patient name' %}<i class="fa-solid fa-user"></i>
            {% elif field.label == 'Patient age' %}<i class="fa-solid fa-hourglass-half"></i>
            {% elif field.label == 'Contact number' %}<i class="fa-solid fa-phone"></i>
            {% elif field.label == 'Reason' %}<i class="fa-solid fa-circle-question"></i>
            {% elif field.label == 'Bloodgroup' %}<i class="fa-solid fa-droplet"></i>
            {% elif field.label == 'Unit' %}<i class="fa-solid fa-vial"></i>
            {% elif field.label == 'Urgency level' %}<i class="fa-solid fa-bolt"></i>
            {% else %}<i class="fa-solid fa-circle"></i>{% endif %}
            {{ field.label }}
          </div>
          <div class="value">
            {{ field|add_class:"input--style-5" }}
            {% if field.help_text %}
              <small class="form-text text-muted">{{ field.help_text }}</small>
            {% endif %}
            {% if field.errors %}
              <ul class="errorlist text-danger small mt-1">
                {% for error in field.errors %}
                  <li>{{ error }}</li>
                {% endfor %}
              </ul>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    
      <!-- Nurse selection errors from form_errors -->
      <div class="form-row {% if form_errors.nurse %}has-error{% endif %}">
        <div class="name"><i class="fa-solid fa-user-nurse"></i> Select Nurse</div>
        <div class="value">
          <select id="nurseDropdown" name="nurse" class="input--style-5" required>
            <option value="">Select a Donation Center first</option>
          </select>
          {% if form_errors.nurse %}
            <ul class="errorlist text-danger small mt-1">
              {% for error in form_errors.nurse %}
                <li>{{ error }}</li>
              {% endfor %}
            </ul>
          {% endif %}
        </div>
      </div>
    
      <!-- Appointment date/time errors -->
      {% if form_errors.date %}
      <div class="form-row has-error">
        <div class="name">Appointment Date & Time</div>
        <div class="value">
          <ul class="errorlist text-danger small mt-1">
            {% for error in form_errors.date %}
              <li>{{ error }}</li>
            {% endfor %}
          </ul>
        </div>
      </div>
      {% endif %}
    
      <!-- Hidden field holding combined appointment datetime -->
      <input type="hidden" name="date" id="appointmentDateTimeHidden" value="{{ appointment_date }}">
    
      <!-- Submit button -->
      <div class="form-row" style="justify-content: center;">
        <button class="btn" type="submit"><i class="fa-solid fa-paper-plane"></i> Submit Request</button>
      </div>
    </form>
    
    {% endif %}
  </div>

  <!-- Appointment Info & Summary Card -->
  <div class="card">
    <div class="form-row">
      <div class="name"><i class="fa-solid fa-calendar-days"></i> Appointment Date</div>
      <div class="value">
        <input type="text" id="appointmentDate" placeholder="Select date" autocomplete="off" disabled class="input--style-5"/>
      </div>
    </div>

    <div class="form-row">
      <div class="name"><i class="fa-solid fa-clock"></i> Appointment Time</div>
      <div class="value" id="timeSlots" role="radiogroup" aria-label="Available appointment times"></div>
    </div>

    <div class="form-row">
      <div class="name"><i class="fa-solid fa-info-circle"></i> Summary</div>
      <div class="value" id="summaryBox" role="region" aria-live="polite"></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
const centerDropdown = document.getElementById('id_donation_center');
const nurseDropdown = document.getElementById('nurseDropdown');
const appointmentDateInput = document.getElementById('appointmentDate');
const appointmentDateTimeHidden = document.getElementById('appointmentDateTimeHidden');
const timeSlotsDiv = document.getElementById('timeSlots');
const summaryBox = document.getElementById('summaryBox');
const timeOptions = ["09:00 AM","10:30 AM","12:00 PM","02:00 PM","04:00 PM"];

let selectedDate = "";

flatpickr("#appointmentDate", {
  minDate: "today",
  dateFormat: "Y-m-d",
  disableMobile: true,
  onChange: function(selectedDates, dateStr) {
    selectedDate = dateStr;
    renderTimeSlots();
    updateSummary();
  }
});

async function fetchBookedTimeSlots(nurseId, date) {
  if (!nurseId || !date) return [];
  try {
    const response = await fetch("{% url 'ajax_booked_timeslots' %}?nurse_id=" + nurseId + "&date=" + date);
    const data = await response.json();
    return data.booked_times || [];
  } catch (err) {
    console.error(err);
    return [];
  }
}

async function renderTimeSlots() {
  timeSlotsDiv.innerHTML = '';
  const nurseId = nurseDropdown.value;
  if (!nurseId || !selectedDate) return;

  const bookedSlots = await fetchBookedTimeSlots(nurseId, selectedDate);
  timeOptions.forEach(slot => {
    const isBooked = bookedSlots.includes(slot);
    const label = document.createElement('label');
    label.className = isBooked ? 'disabled' : '';
    label.innerHTML = `<input type="radio" name="appointment_time_radio" value="${slot}" ${isBooked?'disabled':''}> ${slot}`;
    if (!isBooked) label.querySelector('input').addEventListener('change', () => {
      let [timePart, meridian] = slot.split(" ");
      let [hour, minute] = timePart.split(":");
      hour = parseInt(hour, 10);
      if (meridian === "PM" && hour < 12) hour += 12;
      if (meridian === "AM" && hour === 12) hour = 0;
      hour = hour.toString().padStart(2, "0");
      const finalDateTime = `${selectedDate}T${hour}:${minute}`;
      appointmentDateTimeHidden.value = finalDateTime;
      updateSummary();
    });
    timeSlotsDiv.appendChild(label);
  });
}

function updateSummary() {
  const date = appointmentDateInput.value;
  const nurse = nurseDropdown.options[nurseDropdown.selectedIndex]?.text || '';
  const bloodgroup = document.getElementById('id_bloodgroup')?.value || '';
  const unit = document.getElementById('id_unit')?.value || '';
  const dateTime = appointmentDateTimeHidden.value;

  if(dateTime && nurse){
    summaryBox.style.display='block';
    summaryBox.innerHTML = `📅 Date: ${date}<br>🕒 Time: ${dateTime.split("T")[1]}<br>👨‍⚕️ Nurse: ${nurse}<br>🩸 Blood Group: ${bloodgroup}<br>🧪 Unit: ${unit} ml`;
  } else {
    summaryBox.style.display='none';
    summaryBox.innerHTML='';
  }
}

function toggleAppointmentFields() {
  const centerId = centerDropdown.value;
  if(centerId){
    fetch("{% url 'ajax_get_nurses' %}?center_id="+centerId)
      .then(res=>res.json())
      .then(data=>{
        let options='<option value="">Select a Nurse</option>';
        data.nurses.forEach(nurse=>options+=`<option value="${nurse.id}">${nurse.name}</option>`);
        nurseDropdown.innerHTML=options;
        nurseDropdown.disabled=false;
        appointmentDateInput.disabled=true;
        timeSlotsDiv.innerHTML='';
        summaryBox.innerHTML='';
      });
  } else {
    nurseDropdown.innerHTML='<option value="">Select a Donation Center first</option>';
    nurseDropdown.disabled=true;
    appointmentDateInput.disabled=true;
    timeSlotsDiv.innerHTML='';
    summaryBox.innerHTML='';
  }
}

nurseDropdown.addEventListener('change', ()=>{
  appointmentDateInput.disabled=false;
  renderTimeSlots();
  updateSummary();
});

centerDropdown.addEventListener('change', toggleAppointmentFields);

document.addEventListener('DOMContentLoaded',()=>{
  nurseDropdown.disabled=true;
  appointmentDateInput.disabled=true;
  toggleAppointmentFields();
});
</script>
{% endblock %}
