{% extends 'donor/donorbase.html' %}
{% load widget_tweaks %}
{% load static %}
{% block content %}

<div class="container my-5">
  <div class="row justify-content-center">
    <div class="col-md-8">

      <!-- Display Django messages -->
      {% if messages %}
        <div class="mt-3">
          {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
          {% endfor %}
        </div>
      {% endif %}

      <div class="card shadow-lg rounded">
        <div class="card-header bg-primary text-white text-center">
          <h4><i class="fas fa-user-edit"></i> Edit Profile</h4>
        </div>
        <div class="card-body">
          <form method="post" enctype="multipart/form-data" novalidate>
            {% csrf_token %}
            
            <!-- Profile Picture Preview -->
            <div class="text-center mb-4">
              {% if donor.profile_pic %}
                <img src="{{ donor.profile_pic.url }}" class="rounded-circle border border-3" width="150" height="150" id="previewImg" alt="Profile Picture">
              {% else %}
                <img src="{% static 'images/default-profile.png' %}" class="rounded-circle border border-3" width="150" height="150" id="previewImg" alt="Default Profile Picture">
              {% endif %}
            </div>

            <!-- Profile Picture Upload -->
            <div class="form-group mb-3">
              <label for="profile_pic_upload">Change Profile Picture</label>
              {{ profile_form.profile_pic|add_class:"form-control-file" }}
              {% if profile_form.profile_pic.errors %}
                <small class="text-danger">{{ profile_form.profile_pic.errors }}</small>
              {% endif %}
            </div>

            <!-- Render form fields except profile_pic, latitude, longitude -->
            {% for field in profile_form %}
              {% if field.name not in "profile_pic latitude longitude" %}
                <div class="form-group mb-3">
                  <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                  {{ field|add_class:"form-control" }}
                  {% if field.help_text %}
                    <small class="form-text text-muted">{{ field.help_text }}</small>
                  {% endif %}
                  {% if field.errors %}
                    <div class="text-danger">{{ field.errors }}</div>
                  {% endif %}
                </div>
              {% endif %}
            {% endfor %}

            <!-- Hidden latitude and longitude fields -->
            <input type="hidden" name="latitude" id="id_latitude" value="{{ donor.latitude|default_if_none:'' }}">
            <input type="hidden" name="longitude" id="id_longitude" value="{{ donor.longitude|default_if_none:'' }}">

            <!-- Current Location Display and Update Button -->
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div>
                <small>
                  Current Location: 
                  Lat: <span id="current-latitude">{{ donor.latitude|default:"Not set" }}</span>, 
                  Lon: <span id="current-longitude">{{ donor.longitude|default:"Not set" }}</span>
                </small>
              </div>
              <button type="button" id="update-location-btn" class="btn btn-info">
                Update Current Location
              </button>
            </div>

            <!-- Submit button -->
            <button type="submit" class="btn btn-primary">Save Changes</button>

          </form>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- JavaScript: -->

<script>
  // Profile picture live preview
  const previewImg = document.getElementById("previewImg");
  const fileInput = document.querySelector("input[name='profile_pic']");
  if (fileInput) {
    fileInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
          previewImg.src = event.target.result;
        };
        reader.readAsDataURL(file);
      }
    });
  }

  // Update current location button & display
  document.getElementById("update-location-btn").addEventListener("click", function() {
    if (!navigator.geolocation) {
      alert("Geolocation is not supported by your browser");
      return;
    }

    navigator.geolocation.getCurrentPosition(function(position) {
      // Update hidden inputs:
      document.getElementById("id_latitude").value = position.coords.latitude;
      document.getElementById("id_longitude").value = position.coords.longitude;

      // Update displayed coordinates (rounded to 6 decimals)
      document.getElementById("current-latitude").textContent = position.coords.latitude.toFixed(6);
      document.getElementById("current-longitude").textContent = position.coords.longitude.toFixed(6);

      alert("Your current location has been updated. Please save the form to persist changes.");
    }, function() {
      alert("Unable to retrieve your location.");
    });
  });
</script>

{% endblock %}
